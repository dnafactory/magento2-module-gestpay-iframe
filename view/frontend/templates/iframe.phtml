<?php /** @var \DNAFactory\BancaSellaProIframe\Block\Iframe $block */ ?>
<?php /** @var \Magento\Framework\Escaper $escaper */ ?>

<script type="text/javascript" src="<?= $escaper->escapeUrl($block->getJsScript()); ?>"></script>

<script>

    //declaring local object to handle asynchronous responses from the payment page
    var localObj = {};
    //setting up a function to handle asynchronous security check result after creating the iFrame and loading the payment page
    localObj.PaymentPageLoad = function(Result){
        //check for errors, if the Result.ErroCode is 10 the iFrame is created correctly and the security check are passed
        if(Result.ErrorCode == 10 ){
            //iFrame created and and the security check passed
            //now we can show the form with the credit card fields
            //Handle 3D authentication 2nd call
            var PARes = '<?= $escaper->escapeHtml($block->getPaRes()) ?>';
            if (PARes.length > 0){
                //The card holder land for the 2nd call after 3d authentication so we can proceed to process the transaction without showing the form
                document.getElementById('text').innerHTML = 'Payment in progress...';
                GestPay.SendPayment({PARes:PARes,TransKey:'<?= $block->getTansKey() ?>'},localObj.PaymentCallBack);
            }else{
                document.getElementById('InnerFreezePane').className='Off';
                document.getElementById('FreezePane').className='Off';
                document.getElementById('CCForm').className='On';
            }
        }else{
            //An error has occurred, check the Result.ErrorCode and Result.ErrorDescription
            //place error handle code HERE
            document.getElementById('ErrorBox').innerHTML='Error:' + Result.ErrorCode + ' ' + Result.ErrorDescription;
            document.getElementById('ErrorBox').className='On';
            document.getElementById('InnerFreezePane').className = 'Off';
            document.getElementById('FreezePane').className = 'Off'
        }
    }
    //setting up a function to handle payment result
    localObj.PaymentCallBack = function (Result){
        if(Result.ErrorCode == 0 ){
            //Transaction correctly processed
            //Decrypt the string to read the Transaction Result
            document.location.replace('<?= $block->getResponseUrl(); ?>?crypted_string='+ Result.EncryptedString);
        }else{
            //An error has occurred
            //check for 3D authentication required
            if(Result.ErrorCode == 8006){
                //The credit card is enrolled we must send the card holder to the authentication page on the issuer website
                //Get the TransKey, IMPORTANT! this value must be stored for further use
                var TransKey = Result.TransKey;
                var date = new Date();
                date.setTime(date.getTime()+(1200000));
                document.cookie = 'TransKey='+TransKey.toString()+'; expires='+ date.toGMTString() +' ; path=/';
                //put the EcryptedString generated by the WSCryptDecrypt webservice in a cookies for later use, the cookies will expire in 20 minutes
                var date = new Date();
                date.setTime(date.getTime()+(1200000));
                document.cookie = 'encString=<?= $escaper->escapeHtml($block->getEncodingString()) ?>; expires='+ date.toGMTString() +' ; path=/';		//Get the VBVRisp encrypted string required to access the issuer authentication page
                document.cookie ='shopLogin=<?= $escaper->escapeHtml($block->getShopLogin()) ?>; expires='+ date.toGMTString() +' ; path=/'; 	//Get the shopLogin required to access the issuer authentication page
                //Get the VBVRisp encrypted string required to access the issuer authentication page
                var VBVRisp = Result.VBVRisp;
                //redirect the user to the issuer authentication page
                var a = '<?= $escaper->escapeHtml($block->getShopLogin()) ?>';
                var b = VBVRisp;
                var c= document.location.href; //this is the landing page where the user will be redirected after the issuer authentication must be ABSOLUTE

                var AuthUrl = '<?= $escaper->escapeUrl($block->getAuthUrl()) ?>';
                document.location.replace(AuthUrl+'?a='+a+'&b='+b+'&c='+c);
            }else{
                //Hide overlapping layer
                document.getElementById('InnerFreezePane').className='Off';
                document.getElementById('FreezePane').className='Off';
                document.getElementById('submit').disabled=false;
                //Check the ErrorCode and ErrorDescription
                if(Result.ErrorCode == 1119 || Result.ErrorCode == 1120){
                    document.getElementById('ErrorBox').innerHTML='Error:' + Result.ErrorCode +' - ' + Result.ErrorDescription;
                    document.getElementById('ErrorBox').className='On';
                    //alert(Result.ErrorDescription);
                    document.getElementById('CC').focus();
                }
                if(Result.ErrorCode == 1124 || Result.ErrorCode == 1126){
                    document.getElementById('ErrorBox').innerHTML='Error:' + Result.ErrorCode +' - ' + Result.ErrorDescription;
                    document.getElementById('ErrorBox').className='On';
                    //alert(Result.ErrorDescription);
                    document.getElementById('EXPMM').focus();
                }
                if(Result.ErrorCode == 1125){
                    document.getElementById('ErrorBox').innerHTML='Error:' + Result.ErrorCode +' - ' + Result.ErrorDescription;
                    document.getElementById('ErrorBox').className='On';
                    //alert(Result.ErrorDescription);
                    document.getElementById('EXPYY').focus();
                }
                if(Result.ErrorCode == 1149){
                    document.getElementById('ErrorBox').innerHTML='Error:' + Result.ErrorCode +' - ' + Result.ErrorDescription;
                    document.getElementById('ErrorBox').className='On';
                    //alert(Result.ErrorDescription);
                    document.getElementById('CVV2').focus();
                }
                if(Result.ErrorCode != 1149 || Result.ErrorCode != 1119 || Result.ErrorCode != 1120 || Result.ErrorCode != 1124 || Result.ErrorCode != 1126 || Result.ErrorCode != 1125){
                    document.getElementById('ErrorBox').innerHTML='Error:' + Result.ErrorCode +' - ' + Result.ErrorDescription;
                    document.getElementById('ErrorBox').className='On';

                }
            }
        }
    };
    //Send data to GestPay and process transaction
    /**
     * @return {boolean}
     */
    function CheckCC(){
        document.getElementById('submit').disabled=true; //disable submit button
        //raise the Overlap layer
        document.getElementById('FreezePane').className='FreezePaneOn';
        //raise the loading message
        document.getElementById('text').innerHTML = 'Pagamento in corso...';
        document.getElementById('InnerFreezePane').className='On';
        GestPay.SendPayment ({
            CC : document.getElementById('CC').value,
            EXPMM : document.getElementById('EXPMM').value,
            EXPYY : document.getElementById('EXPYY').value,
            CVV2: document.getElementById('CVV2').value,
            BuyerName : document.getElementById('Name').value,
            BuyerEmail : document.getElementById('Email').value
        },localObj.PaymentCallBack);
        return false;
    }
</script>

<!-- Overlap Layer -->
<div id="FreezePane" class="Off"></div>
<div id="InnerFreezePane" class="Off">
    <div id="text"></div>
</div>
<!-- Overlap Layer END -->
<!-- ErrorBox -->
<div id="ErrorBox" class="Off">Error</div>

<!-- Create the iFrame-->
<script type="text/javascript">

    //check if the browser support HTML5 postmessage
    if(BrowserEnabled){
        //Browser enabled
        //Creating the iFrame
        GestPay.CreatePaymentPage('<?= $escaper->escapeHtml($block->getShopLogin()) ?>', '<?= $escaper->escapeHtml($block->getEncodingString()) ?>',localObj.PaymentPageLoad);
        //raise the Overlap layer
        document.getElementById('FreezePane').className='FreezePaneOn';
        //raise the loading message
        document.getElementById('text').innerHTML = 'Loading...';
        document.getElementById('InnerFreezePane').className='On';
        //Handle after 3D authentication second call
    }else{
        //Browser not supported
        //Place error handle code here
        document.getElementById('ErrorBox').innerHTML='Error: Browser not supported';
        document.getElementById('ErrorBox').className='On'
    }

</script>

<div id="Main">
    <!-- Credit card form -->
    <form onsubmit="return CheckCC()">

        <label for="CC">Card Number</label>
        <input type="text" id="CC" autocomplete="off" maxlength="19" placeholder="XXXX XXXX XXXX XXXX" value="4012000000003028"/>

        <label>Exipiry Date (MM/YY)</label>
        <input type="text" id="EXPMM" autocomplete="off" maxlength="2" placeholder="MM" value="05" />
        <input type="text" id="EXPYY" autocomplete="off" maxlength="2"  placeholder="YY" value="27" />
        <label>Security code (Cvv2/4DBC)</label>
        <input type="password" id="CVV2" maxlength="4" />
        <label for="Name">Buyer Name</label>
        <input type="text" id="Name" value="">
        <label for="Email">Buyer Email</label>
        <input type="email" id="Email" value="">

        <input type="submit" value="Proceed" id="submit" />
    </form>
</div>
