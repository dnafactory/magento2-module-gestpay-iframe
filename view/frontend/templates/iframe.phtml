<?php
/** @var \DNAFactory\BancaSellaProIframe\Block\Iframe $block */
/** @var \Magento\Framework\Escaper $escaper */
$block->validateIframe();
?>

<style>
    #maincontent {
        padding-top: 80px;
    }

    #InnerFreezePane, #FreezePane {
        position: fixed;
        width: 100%;
        height: 100%;
        left: 0;
        top: 0;
        background: #FFF;
        z-index: 1200;
        text-align: center;
        padding-top: 25%;
        font-size: 24px;
        font-weight: bold;
        text-transform: uppercase;
    }

    #ErrorBox {
        background: #ff000036;
        margin-bottom: 30px;
        padding: 15px;
        border-radius: 5px;
        color: red;
    }
</style>

<script type="text/javascript" src="<?= $escaper->escapeUrl($block->getJsScript()); ?>"></script>

<script>

    //declaring local object to handle asynchronous responses from the payment page
    var localObj = {};
    //setting up a function to handle asynchronous security check result after creating the iFrame and loading the payment page
    localObj.PaymentPageLoad = function(Result){
        //check for errors, if the Result.ErroCode is 10 the iFrame is created correctly and the security check are passed
        if(Result.ErrorCode == 10 ){
            //iFrame created and and the security check passed
            //now we can show the form with the credit card fields
            //Handle 3D authentication 2nd call
            var PARes = '<?= $escaper->escapeHtml($block->getPaRes()) ?>';
            if (PARes.length > 0){
                //The card holder land for the 2nd call after 3d authentication so we can pxroceed to process the transaction without showing the form
                document.getElementById('text').innerHTML = '<?= $escaper->escapeHtml(__('Payment in progress...')) ?>';
                GestPay.SendPayment({PARes:PARes,TransKey:'<?= $block->getTansKey() ?>'},localObj.PaymentCallBack);
            }else{
                document.getElementById('InnerFreezePane').className='d-none';
                document.getElementById('FreezePane').className='d-none';
                document.getElementById('CCForm').className='d-block';
            }
        }else{
            //An error has occurred, check the Result.ErrorCode and Result.ErrorDescription
            //place error handle code HERE
            document.getElementById('ErrorBox').innerHTML='Error:' + Result.ErrorCode + ' ' + Result.ErrorDescription;
            document.getElementById('ErrorBox').className='d-block';
            document.getElementById('InnerFreezePane').className = 'd-none';
            document.getElementById('FreezePane').className = 'd-none'
        }
    }
    //setting up a function to handle payment result
    localObj.PaymentCallBack = function (Result){
        if(Result.ErrorCode == 0 ){
            //Transaction correctly processed
            //Decrypt the string to read the Transaction Result
            document.location.replace('<?= $block->getResponseUrl(); ?>?crypted_string='+ Result.EncryptedString+'&form_key=<?= /** @noEscape  */ $block->getFormKey() ?>'+"&o_key=<?= urlencode($block->getOKey()) ?>");
        }else{
            //An error has occurred
            //check for 3D authentication required
            if(Result.ErrorCode == 8006){
                //The credit card is enrolled we must send the card holder to the authentication page on the issuer website
                //Get the TransKey, IMPORTANT! this value must be stored for further use
                var TransKey = Result.TransKey;
                var date = new Date();
                date.setTime(date.getTime()+(1200000));
                document.cookie = 'TransKey='+TransKey.toString()+'; expires='+ date.toGMTString() +' ; path=/';
                //put the EcryptedString generated by the WSCryptDecrypt webservice in a cookies for later use, the cookies will expire in 20 minutes
                var date = new Date();
                date.setTime(date.getTime()+(1200000));
                document.cookie = 'encString=<?= $escaper->escapeHtml($block->getEncodingString()) ?>; expires='+ date.toGMTString() +' ; path=/';		//Get the VBVRisp encrypted string required to access the issuer authentication page
                document.cookie ='shopLogin=<?= $escaper->escapeHtml($block->getShopLogin()) ?>; expires='+ date.toGMTString() +' ; path=/'; 	//Get the shopLogin required to access the issuer authentication page
                //Get the VBVRisp encrypted string required to access the issuer authentication page
                var VBVRisp = Result.VBVRisp;
                //redirect the user to the issuer authentication page
                var a = '<?= $escaper->escapeHtml($block->getShopLogin()) ?>';
                var b = VBVRisp;
                var c= document.location.href; //this is the landing page where the user will be redirected after the issuer authentication must be ABSOLUTE

                var AuthUrl = '<?= $escaper->escapeUrl($block->getAuthUrl()) ?>';
                document.location.replace(AuthUrl+'?a='+a+'&b='+b+'&c='+c);
            }else{
                //Hide overlapping layer
                document.getElementById('InnerFreezePane').className='d-none';
                document.getElementById('FreezePane').className='d-none';
                document.getElementById('submit').disabled=false;
                //Check the ErrorCode and ErrorDescription
                if(Result.ErrorCode == 1119 || Result.ErrorCode == 1120){
                    document.getElementById('ErrorBox').innerHTML='Error:' + Result.ErrorCode +' - ' + Result.ErrorDescription;
                    document.getElementById('ErrorBox').className='d-block';
                    //alert(Result.ErrorDescription);
                    document.getElementById('CC').focus();
                }
                if(Result.ErrorCode == 1124 || Result.ErrorCode == 1126){
                    document.getElementById('ErrorBox').innerHTML='Error:' + Result.ErrorCode +' - ' + Result.ErrorDescription;
                    document.getElementById('ErrorBox').className='d-block';
                    //alert(Result.ErrorDescription);
                    document.getElementById('EXPMM').focus();
                }
                if(Result.ErrorCode == 1125){
                    document.getElementById('ErrorBox').innerHTML='Error:' + Result.ErrorCode +' - ' + Result.ErrorDescription;
                    document.getElementById('ErrorBox').className='d-block';
                    //alert(Result.ErrorDescription);
                    document.getElementById('EXPYY').focus();
                }
                if(Result.ErrorCode == 1149){
                    document.getElementById('ErrorBox').innerHTML='Error:' + Result.ErrorCode +' - ' + Result.ErrorDescription;
                    document.getElementById('ErrorBox').className='d-block';
                    //alert(Result.ErrorDescription);
                    document.getElementById('CVV2').focus();
                }
                if(Result.ErrorCode != 1149 || Result.ErrorCode != 1119 || Result.ErrorCode != 1120 || Result.ErrorCode != 1124 || Result.ErrorCode != 1126 || Result.ErrorCode != 1125){
                    document.getElementById('ErrorBox').innerHTML='Error:' + Result.ErrorCode +' - ' + Result.ErrorDescription;
                    document.getElementById('ErrorBox').className='d-block';

                }
            }
        }
    };
    //Send data to GestPay and process transaction
    /**
     * @return {boolean}
     */
    function CheckCC(){
        document.getElementById('submit').disabled=true; //disable submit button
        //raise the Overlap layer
        document.getElementById('FreezePane').className='FreezePaneOn';
        //raise the loading message
        document.getElementById('text').innerHTML = '<?= $escaper->escapeHtml(__('Payment in progress...'))  ?>';
        document.getElementById('InnerFreezePane').className='d-block';
        GestPay.SendPayment ({
            CC : document.getElementById('CC').value,
            EXPMM : document.getElementById('EXPMM').value,
            EXPYY : document.getElementById('EXPYY').value,
            CVV2: document.getElementById('CVV2').value,
            BuyerName : document.getElementById('Name').value,
            BuyerEmail : document.getElementById('Email').value
        },localObj.PaymentCallBack);
        return false;
    }
</script>

<!-- Overlap Layer -->
<div id="FreezePane" class="d-none freeze-popup"></div>
<div id="InnerFreezePane" class="d-none freeze-popup">
    <div id="text"></div>
</div>
<!-- Overlap Layer END -->

<!-- Create the iFrame-->
<script type="text/javascript">

    //check if the browser support HTML5 postmessage
    if(BrowserEnabled){
        //Browser enabled
        //Creating the iFrame
        GestPay.CreatePaymentPage('<?= $escaper->escapeHtml($block->getShopLogin()) ?>', '<?= $escaper->escapeHtml($block->getEncodingString()) ?>',localObj.PaymentPageLoad);
        //raise the Overlap layer
        document.getElementById('FreezePane').className='FreezePaneOn';
        //raise the loading message
        document.getElementById('text').innerHTML = '<?= $escaper->escapeHtml(__('Loading...')) ?>';
        document.getElementById('InnerFreezePane').className='d-block';
        //Handle after 3D authentication second call
    }else{
        //Browser not supported
        //Place error handle code here
        document.getElementById('ErrorBox').innerHTML='Error: Browser not supported';
        document.getElementById('ErrorBox').className='d-block'
    }

</script>

<div id="Main">
    <div class="h1 my-2 my-md-4"><?= /** @noEscape  */ __('Order #%1 Payment - eFarma.com', $block->getOrderId()) ?></div>
    <!-- ErrorBox -->
    <div id="ErrorBox" class="d-none"></div>
    <!-- Credit card form -->
    <form onsubmit="return CheckCC()">
        <div class="fieldset row mx-n1">
            <div class="col-12 field required">
                <label class="label" for="CC"><span><?= /** @noEscape  */ __('Credit Card') ?></span></label>
                <div class="control">
                    <input autocomplete="off" id="CC" maxlength="19" placeholder="XXXX XXXX XXXX XXXX" type="text" class="input-text" title="<?= /** @noEscape  */ __('Credit Card') ?>" aria-required="true">
                </div>
            </div>
            <div class="col-6 field required">
                <label class="label" for="EXPMM"><span><?= /** @noEscape  */ __('Month') ?></span></label>
                <div class="control">
                    <input autocomplete="off" id="EXPMM" maxlength="2" placeholder="MM" type="text" class="input-text" title="<?= /** @noEscape  */ __('Month') ?>" aria-required="true">
                </div>
            </div>
            <div class="col-6 field required">
                <label class="label" for="EXPYY"><span><?= /** @noEscape  */ __('Year') ?></span></label>
                <div class="control">
                    <input autocomplete="off" id="EXPYY" maxlength="2" placeholder="YY" type="text" class="input-text" title="<?= /** @noEscape  */ __('Year') ?>" aria-required="true">
                </div>
            </div>
            <div class="col-12 col-md-6 field required">
                <label class="label" for="CVV2"><span><?= /** @noEscape  */ __('Security code (Cvv2/4DBC)') ?></span></label>
                <div class="control">
                    <input autocomplete="off" id="CVV2" maxlength="4" placeholder="1234" type="password" class="input-text" title="<?= /** @noEscape  */ __('Security code (Cvv2/4DBC)') ?>" aria-required="true">
                </div>
            </div>
            <div class="col-12 col-md-6 field">
                <label class="label" for="Name"><span><?= /** @noEscape  */ __('Buyer Name') ?></span></label>
                <div class="control">
                    <input autocomplete="off" id="Name" type="text" class="input-text" title="<?= /** @noEscape  */ __('Buyer Name') ?>" aria-required="true">
                </div>
            </div>
            <div class="col-12 col-md-6 field">
                <label class="label" for="Email"><span><?= /** @noEscape  */ __('Buyer Email') ?></span></label>
                <div class="control">
                    <input autocomplete="off" id="Email" type="text" class="input-text" title="<?= /** @noEscape  */ __('Buyer Email') ?>" aria-required="true">
                </div>
            </div>
        </div>
        <div class="text-right h5 mb-2"><?= /** @noEscape  */ __('Amount to pay') ?>: <div class="d-inline-block h3"><?= /** @noEscape  */ $block->getAmountToPay() ?></div></div>
        <div class="actions col-12 text-right">
            <button type="submit" id="submit" class="btn btn-primary btn-lg px-6">
                <?= /** @noEscape */ __('Pay') ?>
            </button>
        </div>
    </form>
</div>
